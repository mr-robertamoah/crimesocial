// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email        String? @unique
  username     String  @unique
  firstName    String?
  lastName     String?
  otherNames   String?
  gender       Gender  @default(UNDISCLOSED)
  country      String?
  refreshToken String?
  avatarUrl    String?
  password     String

  admin    Admin?
  agencies Agency[]
  agents   Agent[]
  avatars   Avatar[]
  addedFiles   File[]
  suggestions   Suggestion[] @relation("UserToSuggestion")
  crimeTypes   CrimeType[] @relation("UserToCrimeType")
  crimeCategories   CrimeCategory[] @relation("UserToCrimeCategory")

  reportedCrimes Crime[]
  addedDescriptiveMarkers DescriptiveMarker[]
  posts Post[]
}

model Avatar {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  url String @unique
  path String
  userId Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model File {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  url String @unique
  path String
  mime String
  size Int
  userId Int
  fileableId Int?
  fileableType FileableType?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  crime Crime? @relation("CrimeToFile", fields: [fileableId], references: [id], map: "CrimeFileByIdFKey")
  agency Agency? @relation("AgencyToFile", fields: [fileableId], references: [id], map: "AgencyFileByIdFKey")

  Post Post[]
  FileToPost FileToPost[]
}

enum FileableType {
  Crime
  Agency
  Post
}

model Admin {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  type   AdminType @default(ADMIN)
  userId Int       @unique
  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  verifiedAgencies Agency[]
}

model Agency {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  type       AgencyType @default(GOVERNMENT)
  name       String
  about      String?
  userId     Int
  verifiedBy Int?
  verifiedAt DateTime?

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  admin Admin? @relation(fields: [verifiedBy], references: [id], onDelete: Cascade)

  agents        Agent[]
  crimes        Crime[]         @relation("AgencyToCrime")
  AgencyToCrime AgencyToCrime[]

  suggestions   Suggestion[] @relation("AgencyToSuggestion")
  crimeTypes   CrimeType[] @relation("AgencyToCrimeType")
  crimeCategories   CrimeCategory[] @relation("AgencyToCrimeCategory")
  
  files File[] @relation("AgencyToFile")
  post Post[] @relation("AgencyToPost")
}

model Agent {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  type     AgentType @default(NORMAL)
  position String
  userId   Int
  agencyId Int

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  crimes Crime[] @relation("AgentToCrime")
  AgentToCrime  AgentToCrime[]
  
  suggestions   Suggestion[] @relation("AgentToSuggestion")
  crimeTypes   CrimeType[] @relation("AgentToCrimeType")
  crimeCategories   CrimeCategory[] @relation("AgentToCrimeCategory")
}

enum AgencyType {
  GOVERNMENT
  NONPROFIT
}

enum AgentType {
  NORMAL
  SUPER
}

enum AdminType {
  ADMIN
  SUPERADMIN
}

enum Gender {
  MALE
  FEMALE
  UNDISCLOSED
}

model Crime {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  landmark    String?
  outcome     Outcome   @default(PENDING)
  severity    Int       @default(1)
  name        String
  description String?
  lat         Float
  lon         Float
  occurredOn  DateTime?
  victim      Json?
  suspect     Json?
  userId Int?
  anonymous Boolean
  crimeTypeId Int?
  crimeTypeName String?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  crimeType CrimeType? @relation(fields: [crimeTypeId], references: [id], onDelete: Cascade)

  agents        Agent[]         @relation("AgentToCrime")
  agencies      Agency[]        @relation("AgencyToCrime")
  AgencyToCrime AgencyToCrime[]
  AgentToCrime  AgentToCrime[]

  files File[] @relation("CrimeToFile")
  post Post[] @relation("CrimeToPost")
}

model DescriptiveMarker {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name String
  userId Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Outcome {
  CONVICTION
  PENDING
  ACQUITTAL
}

model AgencyToCrime {
  agencyId Int
  crimeId  Int

  crime  Crime  @relation(fields: [crimeId], references: [id], onDelete: Cascade)
  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@id([agencyId, crimeId])
}

model AgentToCrime {
  agentId Int
  crimeId Int

  crime  Crime  @relation(fields: [crimeId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@id([agentId, crimeId])
}

model Suggestion {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  byId      Int
  byType      String
  type    SuggestionType @default(APP)
  message String

  user User @relation("UserToSuggestion", fields: [byId], references: [id], onDelete: Cascade, map: "UserSuggestionByIdFKey")
  agency Agency @relation("AgencyToSuggestion", fields: [byId], references: [id], onDelete: Cascade, map: "AgencySuggestionByIdFKey")
  agent Agent @relation("AgentToSuggestion", fields: [byId], references: [id], onDelete: Cascade, map: "AgentSuggestionByIdFKey")
}

enum SuggestionType {
  APP
  CRIMECATEGORY
  CRIMETYPE
}

model CrimeCategory {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  byId   Int
  byType String
  name String

  user User @relation("UserToCrimeCategory", fields: [byId], references: [id], onDelete: Cascade, map: "UserCrimeCategoryByIdFKey")
  agency Agency @relation("AgencyToCrimeCategory", fields: [byId], references: [id], onDelete: Cascade, map: "AgencyCrimeCategoryByIdFKey")
  agent Agent @relation("AgentToCrimeCategory", fields: [byId], references: [id], onDelete: Cascade, map: "AgentCrimeCategoryByIdFKey")

  crimeTypes CrimeType[]
}

model CrimeType {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  byId   Int
  byType   String
  name String

  crimeCategoryId Int
  crimeCategory   CrimeCategory @relation(fields: [crimeCategoryId], references: [id], onDelete: Cascade)
  
  user User @relation("UserToCrimeType", fields: [byId], references: [id], onDelete: Cascade, map: "UserCrimeTypeByIdFKey")
  agency Agency @relation("AgencyToCrimeType", fields: [byId], references: [id], onDelete: Cascade, map: "AgencyCrimeTypeByIdFKey")
  agent Agent @relation("AgentToCrimeType", fields: [byId], references: [id], onDelete: Cascade, map: "AgentCrimeTypeByIdFKey")

  crimes Crime[]
}

model Post {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  content String?
  userId Int

  postableId Int
  postableType PostableType

  user User @relation(fields: [userId], references: [id])

  crime Crime? @relation("CrimeToPost", fields: [postableId], references: [id], map: "CrimePostByIdFKey")
  agency Agency? @relation("AgencyToPost", fields: [postableId], references: [id], map: "AgencyPostByIdFKey")

  files File[]
  FileToPost FileToPost[]
}

model FileToPost {
  postId Int
  fileId Int

  post Post @relation(fields: [postId], references: [id])
  file File @relation(fields: [fileId], references: [id])

  @@id([postId, fileId])
}

enum PostableType {
  Agency
  Crime
}